{"ast":null,"code":"\"use strict\";\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar types_1 = require(\"@vibrant/types\");\n// const WorkerClass: TaskWorkerClass = require('worker-loader?inline=true!./worker')\nvar MAX_WORKER_COUNT = 5;\nvar WorkerPool = /** @class */function () {\n  function WorkerPool(WorkerClass) {\n    this.WorkerClass = WorkerClass;\n    this._taskId = 0;\n    this._workers = [];\n    this._queue = [];\n    this._executing = {};\n  }\n  WorkerPool.prototype._findIdleWorker = function () {\n    var worker;\n    // if no idle worker && worker count < max count, make new one\n    if (this._workers.length === 0 || this._workers.length < MAX_WORKER_COUNT) {\n      worker = new this.WorkerClass();\n      worker.id = this._workers.length;\n      worker.idle = true;\n      this._workers.push(worker);\n      worker.onmessage = this._onMessage.bind(this, worker.id);\n    } else {\n      worker = this._workers.find(function (_a) {\n        var idle = _a.idle;\n        return idle;\n      });\n    }\n    return worker;\n  };\n  WorkerPool.prototype._enqueue = function (payload, transferList) {\n    var d = types_1.defer();\n    // make task item\n    var task = {\n      id: this._taskId++,\n      payload: payload,\n      transferList: transferList,\n      deferred: d\n    };\n    this._queue.push(task);\n    // Try dequeue\n    this._tryDequeue();\n    return d.promise;\n  };\n  WorkerPool.prototype._tryDequeue = function () {\n    // Called when a work has finished or from _enqueue\n    // No pending task\n    if (this._queue.length <= 0) return;\n    // Find idle worker\n    var worker = this._findIdleWorker();\n    // No idle worker\n    if (!worker) return;\n    // Dequeue task\n    var task = this._queue.shift();\n    this._executing[task.id] = task;\n    // Send payload\n    var transfers = task.transferList;\n    var deferred = task.deferred,\n      transferList = task.transferList,\n      request = __rest(task, [\"deferred\", \"transferList\"]);\n    worker.postMessage(request, transfers);\n    worker.idle = false;\n  };\n  WorkerPool.prototype._onMessage = function (workerId, event) {\n    var data = event.data;\n    if (!data) return;\n    // Worker should send result along with payload id\n    var id = data.id;\n    // Task is looked up by id\n    var task = this._executing[id];\n    delete this._executing[id];\n    // Resolve or reject deferred promise\n    switch (data.type) {\n      case 'return':\n        task.deferred.resolve(data.payload);\n        break;\n      case 'error':\n        task.deferred.reject(new Error(data.payload));\n        break;\n    }\n    // Update worker status\n    this._workers[workerId].idle = true;\n    // Try dequeue next task\n    this._tryDequeue();\n  };\n  WorkerPool.prototype.invoke = function (args, transferList) {\n    return this._enqueue(args, transferList);\n  };\n  return WorkerPool;\n}();\nexports.default = WorkerPool;","map":{"version":3,"names":["types_1","require","MAX_WORKER_COUNT","WorkerPool","WorkerClass","_taskId","_workers","_queue","_executing","prototype","_findIdleWorker","worker","length","id","idle","push","onmessage","_onMessage","bind","find","_a","_enqueue","payload","transferList","d","defer","task","deferred","_tryDequeue","promise","shift","transfers","request","__rest","postMessage","workerId","event","data","type","resolve","reject","Error","invoke","args"],"sources":["../../../../packages/vibrant-worker/src/pool.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}